@using Mediaverse.Application.ContentSearch.Queries.GetRelevantContent
@using Mediaverse.Application.ContentSearch.Queries.GetRelevantContent.Dtos
@using Mediaverse.Application.JointContentConsumption.Commands.SwitchContent.Dtos
@using Mediaverse.Application.JointContentConsumption.Common.Dtos
@model RoomDto;
@{
    ViewData["Title"] = Model.Name;
}

<h1 class="display-4" style="display: inline-block; padding-left: 7%"><strong>@Model.Name</strong></h1>
<div style="padding-top: 2%; padding-left:7%">
    <div class="room">
        @await Html.PartialAsync("ContentSearchLine", new GetRelevantContentQuery())
    
        @await Html.PartialAsync("ContentPlayer", Model.CurrentlyPlayingContent)

        <div id="playlistContainer"></div>
        <script>
            $.get('@Url.Action("Playlist", "ContentConsumption")', {playlistId: '@Model.ActivePlaylistId'}, function(content){
                    $("#playlistContainer").html(content);
                });
        </script>
    
        @await Html.PartialAsync("SearchResults", new SearchResultDto())
    </div>
</div>

@await Html.PartialAsync("ModalDialog")

<script type="text/javascript">
    window.addEventListener('beforeunload', function (e) {
        leaveRoom();
    });

    const leaveRoom = function(){
        // $.ajax({
        //     type: "POST",
        //     url: '@Url.Action("LeaveRoom", "ContentConsumption")',
        //     data: '@Model.Id',
        //     error: function(xhr, ajaxOptions, thrownError) {
        //         const error = JSON.parse(xhr.responseText);
        //         showModal(" attempt failed", error.message)
        //     }
        // });
    }
     

    const addToPlaylist = function(
        externalId,
        contentSource,
        contentType) {
        
        let contentId = {
            ExternalId: externalId,
            ContentSource: contentSource,
            contentType: contentType
        }
        
        let command = {
            ContentId: contentId,
            CurrentRoomId: '@Model.Id'
        }
        
        $.ajax({
            type: "POST",
            url: '@Url.Action("AddContentToPlaylist", "ContentConsumption")',
            data: command,
            success: function(res) {
                $('#playlist').replaceWith(res);
            },
            error: function(xhr, ajaxOptions, thrownError) {
                const error = JSON.parse(xhr.responseText);
                showModal("Operation attempt failed", error.message)
            }
        });
    };
    
    const removeFromPlaylist = function(
            externalId,
            contentSource,
            contentType) {
            
            let contentId = {
                ExternalId: externalId,
                ContentSource: contentSource,
                contentType: contentType
            }
            
            let command = {
                ContentId: contentId,
                CurrentRoomId: '@Model.Id'
            }
            
            $.ajax({
                type: "POST",
                url: '@Url.Action("RemoveContentFromPlaylist", "ContentConsumption")',
                data: command,
                success: function(res) {
                    $('#playlist').replaceWith(res);
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    const error = JSON.parse(xhr.responseText);
                    showModal("Operation attempt failed", error.message)
                }
            });
        };
    
    const switchContent = function(direction) {  
        let command = {
            RoomId: '@Model.Id',
            Direction: direction
        }
        
        $.ajax({
            type: "POST",
            url: '@Url.Action("SwitchContent", "ContentConsumption")',
            data: command,
            success: function(res) {
                $('#contentPlayer').replaceWith(res);
            },
            error: function(xhr, ajaxOptions, thrownError) {
                const error = JSON.parse(xhr.responseText);
                showModal("Operation attempt failed", error.message)
            }
        });
    };
</script>